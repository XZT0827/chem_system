# 配方成本管理系统

## 📋 系统简介

配方成本管理系统是一个专门为生产和报价配方成本分析设计的Web应用系统。系统支持上传包含配方明细和原料价格的Excel文件，自动计算各配方成本，并提供多维度的成本分析报表。

## ✨ 核心功能

### 1. 数据导入
- **Excel文件上传**: 支持上传包含"配方明细"和"单价"工作表的Excel文件
- **自动解析**: 自动提取产品信息、配方主表、配方原料明细和每日原料价格
- **日期管理**: 使用系统日期作为导入日期，区分每天的数据
- **避免重复**: 自动识别并避免重复配方写入

### 2. 配方管理
- **配方分类**: 区分生产配方和报价配方
- **配方查询**: 按产品编码、产品名称、配方类型查看所有配方
- **配方详情**: 查看每个配方的完整原料清单

### 3. 成本计算
- **自动计算**: 根据原料用量比例和单价自动计算配方总成本
- **智能价格匹配**: 优先使用当日价格，若无则查找最近历史价格
- **缺失价格统计**: 统计缺失价格的原料数量，便于数据完善

### 4. 成本分析
- **配方成本汇总**: 按日期查看所有配方的成本明细
- **最低成本配方**: 自动筛选每个产品的最低成本生产配方和报价配方
- **原料横向明细**: 横向展示配方原料组成，便于配方对比

### 5. 报表导出
- **Excel导出**: 支持将所有报表导出为Excel文件
- **中文表头**: 所有导出文件使用中文表头，符合内部使用习惯
- **格式优化**: 自动调整列宽，优化表格显示效果

## 🗂️ 数据库结构

系统使用SQLite数据库，包含以下表：

### products (产品信息表)
- product_code: 产品编码
- product_name: 产品名称
- product_model: 产品型号
- customer_product_code: 客户产品编码
- customer_product_name: 客户产品名称
- customer_code: 客户编号
- customer_name: 客户名称

### formulas (配方主表)
- id: 配方ID
- import_date: 导入日期
- quotation_no: 报价单号
- document_date: 单据日期
- product_code: 产品编码
- product_name: 产品名称
- customer_product_name: 客户产品名称
- formula_type: 配方类型(生产配方/报价配方)
- created_at: 创建时间

### formula_materials (配方原料明细表)
- id: 明细ID
- formula_id: 配方ID(外键)
- material_code: 原料编码
- material_name: 原料名称
- material_model: 原料型号
- usage_ratio: 用量比例
- unit_price: 单价

### daily_material_prices (每日原料价格表)
- id: 价格ID
- price_date: 价格日期
- material_code: 原料编码
- material_name: 原料名称
- material_model: 原料型号
- unit_price: 单价
- import_date: 导入日期

## 📁 项目结构

```
.
├── app.py                  # Flask主应用
├── database.py            # 数据库初始化和连接
├── import_data.py         # Excel导入处理
├── cost_calculator.py     # 成本计算逻辑
├── export_excel.py        # Excel导出功能
├── requirements.txt       # Python依赖
├── start.sh              # 启动脚本
├── templates/            # HTML模板目录
│   ├── base.html         # 基础模板
│   ├── index.html        # 首页(文件上传)
│   ├── cost_summary.html # 配方成本汇总
│   ├── lowest_cost.html  # 最低成本配方
│   └── materials_detail.html # 配方原料明细
├── uploads/              # 上传文件目录
├── exports/              # 导出文件目录
└── formula_cost.db       # SQLite数据库
```

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install --break-system-packages Flask pandas openpyxl
```

### 2. 初始化数据库

```bash
python3 database.py
```

### 3. 启动应用

```bash
python3 app.py
```

或使用启动脚本：

```bash
./start.sh
```

### 4. 访问系统

打开浏览器访问: http://localhost:5000

## 📊 使用流程

### 步骤1: 准备Excel文件

确保Excel文件包含以下工作表：

**配方明细工作表**（必须包含以下列）：
- 报价单号
- 单据日期
- 客户编号
- 客户名称
- 产品编码
- 产品名称
- 产品型号
- 客户产品编码
- 客户产品名称
- 配方类型（生产配方/报价配方）
- 子件编码
- 子件名称
- 子件型号
- 用量比例
- 单价

**单价工作表**（必须包含以下列）：
- 单据日期
- 存货编码
- 存货名称
- 规格型号
- 原币含税单价

### 步骤2: 上传文件

1. 在首页点击"选择Excel文件"
2. 选择导入日期（默认为今天）
3. 点击"上传并导入数据"
4. 系统自动跳转到配方成本汇总页面

### 步骤3: 查看报表

**配方成本汇总**
- 显示所有配方的成本明细
- 包含产品信息、配方类型、总成本、原料行数等
- 生产配方排在报价配方前面

**最低成本配方**
- 显示每个产品的最低成本生产配方和报价配方
- 便于快速找到最优配方方案

**配方原料明细**
- 横向展示配方的原料组成
- 格式: 原料名称(单价)×用量比例
- 便于横向对比不同配方的原料差异

### 步骤4: 导出Excel

在任何报表页面点击"导出为Excel"按钮即可下载对应的Excel文件。

## 🔍 成本计算说明

### 计算公式

```
配方总成本 = Σ(原料用量比例 × 原料单价)
```

### 价格查找逻辑

1. 优先查找与导入日期完全匹配的原料价格
2. 如果没有匹配的价格，查找该日期之前最近的价格
3. 如果找不到任何价格，标记为"缺失价格"

### 缺失价格处理

- 系统会统计缺失价格的原料数量
- 缺失价格的原料不参与成本计算
- 在报表中用黄色标签标注缺失数量

## 📈 功能特点

### 智能成本分析
- 自动识别生产配方和报价配方
- 自动计算每个产品的最低成本方案
- 支持按日期查看历史成本数据

### 灵活的日期管理
- 可以指定导入日期
- 支持查看任意历史日期的数据
- 避免不同日期数据混淆

### 友好的用户界面
- 响应式设计，支持各种屏幕尺寸
- Bootstrap美化，界面简洁专业
- 中文界面，操作简单直观

### 高效的数据处理
- 批量导入，快速处理大量数据
- 自动去重，避免重复配方
- 索引优化，查询速度快

## ⚙️ 高级配置

### 修改端口

编辑 `app.py` 最后一行：

```python
app.run(host='0.0.0.0', port=5000, debug=True)
```

将 `port=5000` 改为其他端口号。

### 修改上传文件大小限制

编辑 `app.py`：

```python
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB
```

### 数据库备份

定期备份 `formula_cost.db` 文件即可。

## 🛠️ 故障排除

### 问题1: 导入后成本都是0

**原因**: 价格表中的日期与导入日期不匹配

**解决**: 系统已自动使用最近价格查找，如果仍为0，检查原料编码是否匹配

### 问题2: 部分原料缺失价格

**原因**: 价格表中没有该原料的价格记录

**解决**: 在价格表中补充该原料的价格信息，重新导入

### 问题3: 上传文件失败

**原因**: 文件格式不正确或缺少必要的工作表

**解决**: 
- 确保文件格式为.xlsx或.xls
- 确保包含"配方明细"和"单价"两个工作表
- 确保列名与要求一致

### 问题4: 导出Excel打不开

**原因**: 文件正在被其他程序占用

**解决**: 关闭已打开的同名文件，重新导出

## 📝 注意事项

1. **配方类型**: 必须为"生产配方"或"报价配方"，其他值将无法正确分类
2. **编码匹配**: 配方明细中的"子件编码"必须与价格表中的"存货编码"匹配
3. **日期格式**: Excel中的日期应为标准日期格式
4. **数据完整性**: 建议在导入前检查Excel数据的完整性
5. **备份**: 定期备份数据库文件，防止数据丢失

## 🔄 系统更新

### 后续可扩展功能
- 删除指定配方
- 配方版本管理
- 成本趋势分析
- 多用户权限管理
- 更多成本分析维度

## 📞 技术支持

如有问题或建议，请联系系统管理员。

## 📄 许可证

本系统为内部使用系统，版权所有。

---

**最后更新**: 2025-11-25
**系统版本**: 1.0.0
